<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes glow {
      0%, 100% { filter: drop-shadow(0 0 4px rgba(124, 58, 237, 0.5)); }
      50% { filter: drop-shadow(0 0 8px rgba(124, 58, 237, 0.8)); }
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      color: #e2e8f0;
      font-size: 13px;
      animation: fadeIn 0.5s ease-in;
    }

    .header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(124, 58, 237, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.6s ease-out;
    }

    .header-icon {
      width: 32px;
      height: 32px;
      animation: pulse 2s ease-in-out infinite;
    }

    h1 {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    .subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .section {
      margin-bottom: 20px;
      animation: slideIn 0.6s ease-out;
      animation-fill-mode: both;
    }

    .section:nth-child(2) { animation-delay: 0.1s; }
    .section:nth-child(3) { animation-delay: 0.2s; }
    .section:nth-child(4) { animation-delay: 0.3s; }
    .section:nth-child(5) { animation-delay: 0.4s; }

    .info-box {
      background: rgba(30, 41, 59, 0.6);
      border-left: 3px solid #7c3aed;
      border-radius: 8px;
      padding: 14px;
      font-size: 11px;
      color: #cbd5e1;
      line-height: 1.6;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .info-box:hover {
      border-left-color: #a855f7;
      background: rgba(30, 41, 59, 0.8);
    }

    .info-box strong {
      color: #a855f7;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .info-box strong svg {
      width: 16px;
      height: 16px;
      animation: sparkle 2s ease-in-out infinite;
    }

    .status {
      padding: 14px;
      background: rgba(30, 41, 59, 0.6);
      border-left: 3px solid #3b82f6;
      border-radius: 8px;
      font-size: 12px;
      color: #cbd5e1;
      margin-bottom: 16px;
      min-height: 48px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .status svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
    }

    .status.error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
    }

    .status.error svg {
      animation: pulse 1s ease-in-out infinite;
    }

    .status.success {
      border-left-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
      color: #6ee7b7;
    }

    .status.success svg {
      animation: none;
    }

    /* LOG WINDOW */
    .log-window {
      background: #0f172a;
      border-radius: 10px;
      padding: 16px;
      max-height: 250px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.6;
      color: #94a3b8;
      margin-bottom: 16px;
      border: 1px solid rgba(124, 58, 237, 0.2);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .log-window:hover {
      border-color: rgba(124, 58, 237, 0.4);
    }

    .log-window::-webkit-scrollbar {
      width: 8px;
    }

    .log-window::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 4px;
    }

    .log-window::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #7c3aed 0%, #a855f7 100%);
      border-radius: 4px;
    }

    .log-window::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #a855f7 0%, #c084fc 100%);
    }

    .log-entry {
      margin-bottom: 6px;
      word-wrap: break-word;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 4px 0;
    }

    .log-entry svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      margin-top: 2px;
      animation: sparkle 2s ease-in-out infinite;
    }

    .log-entry.success {
      color: #6ee7b7;
    }

    .log-entry.error {
      color: #fca5a5;
    }

    .log-entry.error svg {
      animation: pulse 1s ease-in-out infinite;
    }

    .log-entry.info {
      color: #7dd3fc;
    }

    .button {
      width: 100%;
      padding: 14px 20px;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(124, 58, 237, 0.4);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .button:hover::before {
      left: 100%;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(124, 58, 237, 0.6);
      background: linear-gradient(135deg, #8b5cf6 0%, #c084fc 100%);
    }

    .button:active {
      transform: translateY(0);
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .button svg {
      width: 18px;
      height: 18px;
      animation: rotate 2s linear infinite;
    }

    .button:disabled svg {
      animation: none;
    }

    .button-secondary {
      background: linear-gradient(135deg, #475569 0%, #64748b 100%);
      box-shadow: 0 4px 16px rgba(71, 85, 105, 0.3);
    }

    .button-secondary:hover {
      background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
      box-shadow: 0 6px 24px rgba(100, 116, 139, 0.5);
    }

    .code-output {
      display: none;
      animation: slideIn 0.5s ease-out;
    }

    .code-output.visible {
      display: block;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #e2e8f0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title svg {
      width: 18px;
      height: 18px;
      animation: glow 2s ease-in-out infinite;
    }

    .code-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .code-tab {
      flex: 1;
      padding: 10px;
      background: rgba(30, 41, 59, 0.6);
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      color: #94a3b8;
      backdrop-filter: blur(10px);
    }

    .code-tab.active {
      background: rgba(124, 58, 237, 0.2);
      border-color: #7c3aed;
      color: #c084fc;
      box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
    }

    .code-tab:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(124, 58, 237, 0.5);
    }

    .code-container {
      position: relative;
    }

    .code-box {
      display: none;
      background: #0f172a;
      border-radius: 10px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.5;
      color: #e2e8f0;
      white-space: pre-wrap;
      word-break: break-all;
      border: 1px solid rgba(124, 58, 237, 0.3);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .code-box.visible {
      display: block;
    }

    .code-box::-webkit-scrollbar {
      width: 8px;
    }

    .code-box::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 4px;
    }

    .code-box::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #7c3aed 0%, #a855f7 100%);
      border-radius: 4px;
    }

    .code-box::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #a855f7 0%, #c084fc 100%);
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 8px 14px;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(124, 58, 237, 0.4);
    }

    .copy-btn:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #c084fc 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.6);
    }

    .copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .toggle-log-btn {
      padding: 6px 14px;
      background: rgba(30, 41, 59, 0.6);
      color: #cbd5e1;
      border: 2px solid rgba(124, 58, 237, 0.3);
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
    }

    .toggle-log-btn:hover {
      background: rgba(124, 58, 237, 0.2);
      border-color: #7c3aed;
      color: #c084fc;
    }

    .toggle-log-btn svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }

    .log-window.collapsed {
      display: none;
    }

    .token-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(124, 58, 237, 0.3);
      border-radius: 10px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.8);
      color: #e2e8f0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .token-input:focus {
      outline: none;
      border-color: #7c3aed;
      background: rgba(15, 23, 42, 1);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    .token-hint {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 8px;
      font-style: italic;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="header">
    <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#7c3aed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      <path d="M2 17L12 22L22 17" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      <path d="M2 12L12 17L22 12" stroke="#c084fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
    </svg>
    <div>
      <h1>Figma ‚Üí Rust CUI</h1>
      <p class="subtitle">–≠–∫—Å–ø–æ—Ä—Ç –≤ C# –∫–æ–¥ –¥–ª—è –∏–≥—Ä—ã Rust</p>
    </div>
  </div>

  <!-- API Token Input -->
  <div class="section">
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="#7c3aed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <circle cx="12" cy="10" r="3" stroke="#a855f7" stroke-width="2" fill="none"/>
      </svg>
      <span>API –¢–æ–∫–µ–Ω:</span>
    </div>
    <input 
      type="text" 
      id="api-token" 
      class="token-input" 
      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à API —Ç–æ–∫–µ–Ω"
      value=""
    />
    <div class="token-hint">–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–ª–∞–≥–∏–Ω–µ. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∞ —Å–∞–π—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ API.</div>
  </div>

  <div class="section">
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2V22M2 12H22" stroke="#7c3aed" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="12" r="3" stroke="#a855f7" stroke-width="2" fill="none"/>
      </svg>
      <span>–ú–∞—Å—à—Ç–∞–± UI (—ç–∫—Å–ø–æ—Ä—Ç):</span>
    </div>
    <input type="number" id="ui-scale" class="token-input" value="1" step="0.05" min="0.25" max="3" />
    <div class="token-hint">1.00 = —Ä–∞–∑–º–µ—Ä –∫–∞–∫ –≤ Figma. –£–º–µ–Ω—å—à–∏—Ç–µ, –µ—Å–ª–∏ –≤ –∏–≥—Ä–µ –≤—ã–≥–ª—è–¥–∏—Ç –∫—Ä—É–ø–Ω–µ–µ.</div>
  </div>

  <div class="section">
    <div class="status" id="status">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>–û–∂–∏–¥–∞–Ω–∏–µ... –í—ã–±–µ—Ä–∏—Ç–µ —Ñ—Ä–µ–π–º</span>
    </div>
  </div>

  <!-- LOG WINDOW -->
  <div class="section">
    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
      <span style="display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
        <span>–õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π:</span>
      </span>
      <button class="toggle-log-btn" onclick="toggleLogs()" id="toggle-log-btn">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
        <span>–ü–æ–∫–∞–∑–∞—Ç—å</span>
      </button>
    </div>
    <div class="log-window collapsed" id="log-window">
      <div class="log-entry info">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</span>
      </div>
    </div>
  </div>

  <div class="section">
    <button class="button" id="generate" onclick="generateCode()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
      <span>–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</span>
    </button>
    <button class="button button-secondary" onclick="cancel()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>–ó–∞–∫—Ä—ã—Ç—å</span>
    </button>
  </div>

  <div class="code-output" id="code-output">
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>–†–µ–∑—É–ª—å—Ç–∞—Ç:</span>
    </div>
    
    <div class="code-tabs">
      <div class="code-tab active" data-tab="cui" onclick="switchTab('cui')">CUI JSON</div>
      <div class="code-tab" data-tab="csharp" onclick="switchTab('csharp')">C# Code</div>
    </div>

    <div class="code-container">
      <button class="copy-btn" onclick="copyCode()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/>
        </svg>
        <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>
      <div class="code-box visible" id="code-cui"></div>
      <div class="code-box" id="code-csharp"></div>
    </div>
  </div>

  <script>
    let currentTab = 'cui';
    let generatedCUI = '';
    let generatedCSharp = '';

    function generateCode() {
      const btn = document.getElementById('generate');
      btn.disabled = true;
      const btnText = btn.querySelector('span');
      btnText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
      
      const apiToken = document.getElementById('api-token').value.trim();
      const scale = parseFloat(document.getElementById('ui-scale').value) || 1;
      
      if (!apiToken) {
        alert('–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω!');
        btn.disabled = false;
        btnText.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥';
        return;
      }

      // persist token locally (figma client storage)
      try { parent.postMessage({ pluginMessage: { type: 'save-token', apiToken } }, '*'); } catch(_) {}
      
      document.getElementById('code-output').classList.remove('visible');
      clearLog();
      addLog('–ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é...', 'info');
      
      parent.postMessage({ pluginMessage: { type: 'generate-code', apiToken, scale } }, '*');
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    const tokenInput = document.getElementById('api-token');
    tokenInput.addEventListener('change', () => {
      const apiToken = tokenInput.value.trim();
      parent.postMessage({ pluginMessage: { type: 'save-token', apiToken } }, '*');
    });

    function cancel() {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    }

    function switchTab(tab) {
      currentTab = tab;
      
      // Update tabs
      document.querySelectorAll('.code-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      
      // Update code boxes
      document.querySelectorAll('.code-box').forEach(box => {
        box.classList.remove('visible');
      });
      document.getElementById(`code-${tab}`).classList.add('visible');
    }

    function copyCode() {
      const code = currentTab === 'cui' ? generatedCUI : generatedCSharp;
      
      // Copy to clipboard
      const textarea = document.createElement('textarea');
      textarea.value = code;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Show feedback
      const btn = event.target.closest('.copy-btn');
      const btnText = btn.querySelector('span');
      const originalText = btnText.textContent;
      btnText.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      addLog('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
      setTimeout(() => {
        btnText.textContent = originalText;
      }, 2000);
    }

    function clearLog() {
      document.getElementById('log-window').innerHTML = '';
    }

    function getLogIcon(type) {
      if (type === 'success') {
        return '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>';
      } else if (type === 'error') {
        return '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
      } else {
        return '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
      }
    }

    function addLog(message, type = 'info') {
      const logWindow = document.getElementById('log-window');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `${getLogIcon(type)}<span>${message}</span>`;
      logWindow.appendChild(entry);
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ (—É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ)
      const MAX_LOGS = 200;
      while (logWindow.children.length > MAX_LOGS) {
        logWindow.removeChild(logWindow.firstChild);
      }
      
      logWindow.scrollTop = logWindow.scrollHeight;
    }

    function toggleLogs() {
      const logWindow = document.getElementById('log-window');
      const toggleBtn = document.getElementById('toggle-log-btn');
      const toggleIcon = toggleBtn.querySelector('svg');
      
      if (logWindow.classList.contains('collapsed')) {
        logWindow.classList.remove('collapsed');
        toggleBtn.querySelector('span').textContent = '–°–∫—Ä—ã—Ç—å';
        toggleIcon.style.transform = 'rotate(180deg)';
      } else {
        logWindow.classList.add('collapsed');
        toggleBtn.querySelector('span').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
        toggleIcon.style.transform = 'rotate(0deg)';
      }
    }

    function updateStatusIcon(type, message) {
      const status = document.getElementById('status');
      let icon = '';
      
      if (type === 'error') {
        icon = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
      } else if (type === 'success') {
        icon = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.7088 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      } else {
        icon = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
      }
      
      status.innerHTML = icon + '<span>' + message + '</span>';
    }

    // Handle messages from plugin
    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'status') {
        updateStatusIcon('info', msg.message);
      } 
      else if (msg.type === 'log') {
        // –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
        let cleanMessage = msg.message
          .replace(/üéÆ|üîë|üß≠|üìä|‚ö°|‚úï|üìÑ|üìã|‚è≥|‚ö†Ô∏è|üöÄ|üîç|üì∏|‚úÖ|‚ùå|üéâ|üì§|‚è≥|üîÅ|üìä|üî®|üåê|üîë|üì•|üìÑ|‚ö†Ô∏è|‚öôÔ∏è/g, '')
          .trim();
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ª–æ–≥–∞
        let logType = 'info';
        if (msg.message.includes('‚úÖ') || msg.message.includes('üéâ') || msg.message.includes('—É—Å–ø–µ—à–Ω–æ') || msg.message.includes('–ì–æ—Ç–æ–≤–æ')) {
          logType = 'success';
        } else if (msg.message.includes('‚ùå') || msg.message.includes('–û—à–∏–±–∫–∞') || msg.message.includes('–æ—à–∏–±–∫–∞')) {
          logType = 'error';
        }
        addLog(cleanMessage, logType);
      }
      else if (msg.type === 'error') {
        updateStatusIcon('error', msg.message);
        addLog(msg.message, 'error');
        
        const btn = document.getElementById('generate');
        btn.disabled = false;
        btn.querySelector('span').textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥';
      } 
      else if (msg.type === 'code-generated') {
        generatedCUI = msg.cui;
        generatedCSharp = msg.csharp;
        
        document.getElementById('code-cui').textContent = msg.cui;
        document.getElementById('code-csharp').textContent = msg.csharp;
        document.getElementById('code-output').classList.add('visible');
        
        updateStatusIcon('success', '–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
        addLog('–ì–æ—Ç–æ–≤–æ! –ö–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'success');
        
        const btn = document.getElementById('generate');
        btn.disabled = false;
        btn.querySelector('span').textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥';
      }
      else if (msg.type === 'prefill-token') {
        const { apiToken } = msg;
        if (apiToken) {
          const input = document.getElementById('api-token');
          input.value = apiToken;
        }
      }
    };
  </script>
</body>
</html>
