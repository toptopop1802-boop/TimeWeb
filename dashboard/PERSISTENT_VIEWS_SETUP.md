# üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Persistent Views (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏–ª–∏ —Å–∞–π—Ç–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ (—Ç–∏–∫–µ—Ç—ã, –∑–∞—è–≤–∫–∏, –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ —Ä–æ–ª–∏) –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏.

## –†–µ—à–µ–Ω–∏–µ
–¢–µ–ø–µ—Ä—å –≤—Å–µ persistent views —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Supabase –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

## –®–∞–≥–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ Supabase

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `setup_persistent_views.sql` –≤ –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase:

```bash
# –í–æ–π–¥–∏—Ç–µ –≤ Supabase Dashboard ‚Üí SQL Editor
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ setup_persistent_views.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É:

```bash
psql "postgresql://..." < dashboard/setup_persistent_views.sql
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` —Ñ–∞–π–ª–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
python start.py
```

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ó–∞–≥—Ä—É–∑–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ persistent views –∏–∑ –ë–î
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. –£–¥–∞–ª–∏—Ç –∏–∑ –ë–î views –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤/—Å–æ–æ–±—â–µ–Ω–∏–π

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏/—Ç–∏–∫–µ—Ç–∞:

```python
# –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç view –≤ –ë–î
await bot.db.save_persistent_view(
    guild_id=guild.id,
    channel_id=channel.id,
    message_id=msg.id,
    view_type="tournament_role",  # –∏–ª–∏ "gradient_role", "help", "moderator", –∏ —Ç.–¥.
    view_data={
        "applicant_id": user_id,
        "role_name": "–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ —Ç—É—Ä–Ω–∏—Ä–∞",
        # ... –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
    }
)
```

### –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:

```python
# –ë–æ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ views
persistent_views = await bot.db.get_active_persistent_views(guild_id)

for view_data in persistent_views:
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    if view_type == "tournament_role":
        view = TournamentRoleApprovalView(...)
        await message.edit(view=view)
```

### –ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:

```python
# –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º view –≤ –ë–î
await bot.db.deactivate_persistent_view(message_id)
```

## –¢–∏–ø—ã persistent views

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –î–∞–Ω–Ω—ã–µ |
|-----|----------|--------|
| `gradient_role` | –ó–∞—è–≤–∫–∞ –Ω–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—É—é —Ä–æ–ª—å —Å –¥–∞—à–±–æ—Ä–¥–∞ | role_name, color1, members |
| `tournament_role` | –ó–∞—è–≤–∫–∞ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä–Ω—É—é —Ä–æ–ª—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞ | applicant_id, role_name, role_color |
| `help` | –¢–∏–∫–µ—Ç –ø–æ–º–æ—â–∏ | applicant_id, application_type |
| `moderator` | –ó–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ | applicant_id, application_type |
| `administrator` | –ó–∞—è–≤–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | applicant_id, application_type |
| `unban` | –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞–∑–±–∞–Ω | applicant_id, application_type |

## –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ views –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `is_active = false` –ø—Ä–∏:
- –û–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏
- –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏
- –£–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
- –£–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

–ß—Ç–æ–±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î:

```sql
-- –£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ views —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
DELETE FROM persistent_views
WHERE is_active = false
AND updated_at < NOW() - INTERVAL '30 days';
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
–°–æ–∑–¥–∞–π—Ç–µ —Ç–∏–∫–µ—Ç –∏–ª–∏ –∑–∞—è–≤–∫—É –Ω–∞ —Ä–æ–ª—å

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
```sql
SELECT * FROM persistent_views WHERE is_active = true ORDER BY created_at DESC;
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
python start.py
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏:
```
INFO: Restoring persistent views for existing channels...
INFO: Restored tournament role view in channel 1234567890
INFO: Persistent views restored from database
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–Ω–æ–ø–∫–∏
–û—Ç–∫—Ä–æ–π—Ç–µ Discord –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

## –û—Ç–ª–∞–¥–∫–∞

### –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:
```python
if bot.db:
    print("‚úÖ Database connected")
else:
    print("‚ùå Database NOT connected")
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:
```
grep "Restoring persistent views" debug.log
grep "Restored.*view" debug.log
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ –ë–î:
```sql
SELECT COUNT(*) FROM persistent_views WHERE is_active = true;
```

### View –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–µ—Ç–æ–¥ `save_persistent_view` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:

```python
logging.info(f"Saving persistent view: {view_type}")
await bot.db.save_persistent_view(...)
```

### –ö–∞–Ω–∞–ª —É–¥–∞–ª—ë–Ω, –Ω–æ view –æ—Å—Ç–∞–ª–∞—Å—å –≤ –ë–î

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è view –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.

–ò–ª–∏ –æ—á–∏—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:
```sql
-- –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å views –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
UPDATE persistent_views 
SET is_active = false 
WHERE channel_id NOT IN (
    SELECT channel_id FROM guild_channels
);
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç ~10-50 views –∑–∞ 1-2 —Å–µ–∫—É–Ω–¥—ã
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ view –≤ –ë–î: ~50-100ms
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ view: ~100-200ms –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—â–∏—â—ë–Ω–Ω–æ–π –ë–î Supabase
- –¢–æ–∫–µ–Ω—ã –∏ —Å–µ–∫—Ä–µ—Ç—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- –î–æ—Å—Ç—É–ø –∫ –ë–î —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SUPABASE_KEY

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f debug.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `SELECT * FROM persistent_views LIMIT 10;`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: `python start.py`

---

‚úÖ **–¢–µ–ø–µ—Ä—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞!**

