# ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

## Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:

### âœ… 1. ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸: `duplicate key value violates unique constraint "users_username_key"`

**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:** Race condition - Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ñ‹Ñ‚Ð°Ð»Ð¸ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾.

**Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:**
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿ÐµÑ€ÐµÐ´ Ð²ÑÑ‚Ð°Ð²ÐºÐ¾Ð¹
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ð° (ÐºÐ¾Ð´ `23505`)
- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº

### âœ… 2. Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐºÐ°Ñ€Ñ‚ Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐ»Ð¸ÑÑŒ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ….

**Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:**
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ `images_metadata`
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
- Ð¡Ð¾Ð·Ð´Ð°Ð½ SQL Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ…

---

## ðŸš€ ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:

```bash
# 1. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
ssh root@bublickrust.ru

# 2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd /root/dsbot

# 3. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
git pull origin main

# 4. ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚Ðµ SQL Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ images_metadata
# Ð’ Supabase Dashboard â†’ SQL Editor â†’ New query
```

Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ SQL Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð° `dashboard/setup_images_metadata.sql`:

```sql
-- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
CREATE TABLE IF NOT EXISTS images_metadata (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    image_id UUID NOT NULL UNIQUE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    original_name TEXT NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type TEXT,
    storage_path TEXT NOT NULL,
    short_code TEXT NOT NULL UNIQUE,
    view_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ°
CREATE INDEX IF NOT EXISTS idx_images_metadata_user_id ON images_metadata (user_id);
CREATE INDEX IF NOT EXISTS idx_images_metadata_short_code ON images_metadata (short_code);
CREATE INDEX IF NOT EXISTS idx_images_metadata_created_at ON images_metadata (created_at DESC);
```

```bash
# 5. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ dashboard
cd dashboard
pm2 restart dsbot

# 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸
pm2 logs dsbot --lines 100
```

---

## ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:

### 1. Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ñ Ñ‚ÐµÐ¼ Ð¶Ðµ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ð´Ð²Ð°Ð¶Ð´Ñ‹:

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ðµ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ:**
- ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð·: âœ… Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°
- Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ€Ð°Ð·: âŒ "Ð­Ñ‚Ð¾ Ð¸Ð¼Ñ ÑƒÐ¶Ðµ Ð·Ð°Ð½ÑÑ‚Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ðµ Ð¸Ð¼Ñ."

**Ð’ Ð»Ð¾Ð³Ð°Ñ… ÑÐµÑ€Ð²ÐµÑ€Ð°:**
```
âœ… New user created: username
```

Ð¸Ð»Ð¸

```
âš ï¸  User exists with password: username
```

### 2. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹

Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Figma Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ.

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ðµ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ:**
- âœ… Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾
- âœ… ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð² Ð±Ð°Ð·Ñƒ
- âœ… ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ short_code Ð¸ directUrl

**Ð’ Ð»Ð¾Ð³Ð°Ñ… ÑÐµÑ€Ð²ÐµÑ€Ð°:**
```
ðŸ“¤ [Image Upload] Request received
   âœ… Authenticated as: username
   âœ… Image metadata saved: ABC1234
   ðŸŽ‰ Upload complete: https://bublickrust.ru/i/ABC1234
```

### 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

Ð’ Supabase Dashboard â†’ Table Editor:

**Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `images_metadata`:**
- Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸
- Ð¡Ñ‚Ð¾Ð»Ð±Ñ†Ñ‹: `image_id`, `user_id`, `short_code`, `original_name`, `file_size`

**Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `user_actions`:**
- Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼ `image_upload`

---

## ðŸ“Š ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¾ÑˆÐ¸Ð±Ð¾Ðº

ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ ÑÐ»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð»Ð¾Ð³Ð°Ð¼Ð¸:

```bash
# Ð¡Ð»ÐµÐ´Ð¸Ñ‚ÑŒ Ð·Ð° Ð»Ð¾Ð³Ð°Ð¼Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
pm2 logs dsbot

# ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 200 ÑÑ‚Ñ€Ð¾Ðº
pm2 logs dsbot --lines 200

# ÐŸÐ¾Ð¸ÑÐº Ð¾ÑˆÐ¸Ð±Ð¾Ðº
pm2 logs dsbot --lines 500 | grep "âŒ"
```

---

## âš ï¸ Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ð¾ÑÑ‚Ð°Ð»Ð°ÑÑŒ:

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 1: ÐžÑˆÐ¸Ð±ÐºÐ° "duplicate key" Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð¿Ð¾ÑÐ²Ð»ÑÐµÑ‚ÑÑ

**Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð°Ñ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°:** Ð’ Ð±Ð°Ð·Ðµ ÐµÑÑ‚ÑŒ "Ð·Ð¾Ð¼Ð±Ð¸" Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ñ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ `password_hash`.

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** Ð£Ð´Ð°Ð»Ð¸Ñ‚Ðµ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸Ñ…:

```sql
-- ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹
SELECT username, COUNT(*) 
FROM users 
GROUP BY username 
HAVING COUNT(*) > 1;

-- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ñ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
DELETE FROM users 
WHERE id NOT IN (
    SELECT MIN(id) 
    FROM users 
    GROUP BY username
);
```

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 2: Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ

**ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:**

1. **Bucket "images" ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚** Ð² Supabase Storage
2. **ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°** Ð½Ð° bucket:
   ```
   Policy: Allow public read access
   SELECT: Enable for public
   ```
3. **Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `images_metadata` ÑÐ¾Ð·Ð´Ð°Ð½Ð°** (ÑÐ¼. SQL Ð²Ñ‹ÑˆÐµ)

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 3: Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `images_metadata` Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ

**ÐžÑˆÐ¸Ð±ÐºÐ°:** `relation "images_metadata" does not exist`

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:**
1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Supabase Dashboard
2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² SQL Editor
3. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²ÐµÑÑŒ SQL Ð¸Ð· `dashboard/setup_images_metadata.sql`
4. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ñ€Ð¾Ñ
5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‡Ñ‚Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾ÑÐ²Ð¸Ð»Ð°ÑÑŒ Ð² Table Editor

---

## ðŸŽ¯ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:

ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹:

âœ… Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº duplicate key  
âœ… Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² Storage Ð¸ Ð² Ð±Ð°Ð·Ñƒ  
âœ… ÐšÐ°Ñ€Ñ‚Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾  
âœ… Ð’ÑÐµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð² `user_actions`  
âœ… Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸  

---

## ðŸ“ž Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ:

ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°:

```bash
pm2 logs dsbot --lines 200 > server_logs.txt
cat server_logs.txt
```

